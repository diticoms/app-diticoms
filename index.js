import Ft from"react";import{createRoot as Ht}from"react-dom/client";import{useState as G,useEffect as Ot,useCallback as Me,useMemo as _t}from"react";import{Settings as Et,LogOut as Dt}from"lucide-react";import{useState as ve}from"react";import{User as We,Lock as Ye}from"lucide-react";import{jsx as Ve}from"react/jsx-runtime";var V=({className:e="",size:r=64})=>Ve("img",{src:"public/logo.png",alt:"Logo",width:r,height:r,className:`${e} object-contain`,loading:"eager",onError:o=>{let m=o.target;m.src.indexOf("public/")!==-1&&(m.src="logo.png")}});import{jsx as O,jsxs as ee}from"react/jsx-runtime";var Ne=({onLogin:e,isLoading:r})=>{let[o,m]=ve(""),[d,c]=ve("");return O("div",{className:"min-h-screen flex items-center justify-center bg-slate-50 p-6 font-sans text-sm",children:ee("div",{className:"max-w-md w-full bg-white rounded-[32px] shadow-lg border border-slate-100 p-8 space-y-8 relative overflow-hidden",children:[r&&O("div",{className:"absolute inset-0 bg-white/98 z-[100] flex flex-col items-center justify-center space-y-6",children:ee("div",{className:"relative flex flex-col items-center",children:[O(V,{size:80,className:"animate-pulse"}),O("div",{className:"mt-8 text-center",children:O("p",{className:"font-black text-blue-600 uppercase tracking-[0.3em] text-[10px]",children:"\u0110ANG T\u1EA2I..."})})]})}),ee("div",{className:"flex flex-col items-center text-center space-y-3",children:[O(V,{size:64,className:r?"animate-pulse":""}),ee("div",{children:[O("h1",{className:"text-xl font-bold text-slate-800 uppercase tracking-tight",children:"DITICOMS SERVICE"}),O("p",{className:"font-bold text-slate-400 uppercase tracking-widest text-[10px] mt-1",children:"H\u1EC7 th\u1ED1ng qu\u1EA3n l\xFD n\u1ED9i b\u1ED9"})]})]}),ee("form",{onSubmit:N=>{N.preventDefault(),o&&d&&e(o,d)},className:"space-y-4",children:[ee("div",{className:"relative",children:[O(We,{className:"absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 z-10",size:18}),O("input",{type:"text",placeholder:"T\xEAn \u0111\u0103ng nh\u1EADp",className:"w-full pl-12 pr-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:bg-white focus:border-blue-400 font-medium",value:o,onChange:N=>m(N.target.value),required:!0,autoComplete:"username",spellCheck:"false"})]}),ee("div",{className:"relative",children:[O(Ye,{className:"absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 z-10",size:18}),O("input",{type:"password",placeholder:"M\u1EADt kh\u1EA9u",className:"w-full pl-12 pr-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:bg-white focus:border-blue-400 font-medium",value:d,onChange:N=>c(N.target.value),required:!0,autoComplete:"current-password"})]}),O("button",{type:"submit",disabled:r,className:"w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-md active:bg-blue-700 transition-colors uppercase tracking-widest mt-2",children:"\u0110\u0102NG NH\u1EACP"})]}),O("div",{className:"pt-4 text-center border-t border-slate-50",children:O("p",{className:"font-bold text-slate-300 uppercase tracking-widest text-[9px]",children:"v1.0.44 \u2022 diticoms.vn"})})]})})};import{useState as ye,useMemo as Qe,useRef as ce}from"react";import{Search as ke,ChevronRight as Ze,Calendar as et,Filter as tt,CheckCircle2 as st,Phone as at,MapPin as nt,Download as rt,Users as ot}from"lucide-react";import*as ae from"xlsx";var be=()=>new Date().toISOString().split("T")[0];var H=e=>{let r=typeof e=="number"?e:parseInt(String(e).replace(/\D/g,""),10);return isNaN(r)?"0":r.toLocaleString("vi-VN")},ie=e=>{if(typeof e=="number")return e;let r=String(e||"0"),o=parseInt(r.replace(/\D/g,""),10);return isNaN(o)?0:o};function we(e,r){let o;return(...m)=>{clearTimeout(o),o=setTimeout(()=>e(...m),r)}}import{jsx as b,jsxs as x}from"react/jsx-runtime";var Se=({data:e,loading:r,technicians:o,selectedId:m,onSelectRow:d,filters:c,setFilters:h,currentUser:N})=>{let v=N?.role==="admin",[y,z]=ye(c.searchTerm),[M,_]=ye(null),R=ce(null),P=ce(!1),U=ce({x:0,y:0}),F=ce(!1),Q=Qe(()=>we(n=>h.setSearchTerm(n),300),[h]),E=n=>{z(n.target.value),Q(n.target.value)},B=()=>{if(e.length===0)return alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u!");let n=e.map(S=>({"Ng\xE0y nh\u1EADp":(S.created_at||"").split("T")[0],"Kh\xE1ch h\xE0ng":S.customerName,"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i":S.phone,"\u0110\u1ECBa ch\u1EC9":S.address,"K\u1EF9 thu\u1EADt vi\xEAn":S.technician||"Ch\u01B0a ph\xE2n c\xF4ng","N\u1ED9i dung":S.content,"Doanh thu (\u0111)":Number(S.revenue||0),"Gi\xE1 v\u1ED1n (\u0111)":Number(S.cost||0),"L\u1EE3i nhu\u1EADn (\u0111)":Number(S.revenue||0)-Number(S.cost||0),"C\xF4ng n\u1EE3 (\u0111)":Number(S.debt||0),"Tr\u1EA1ng th\xE1i":S.status})),k=ae.utils.json_to_sheet(n),J=ae.utils.book_new();ae.utils.book_append_sheet(J,k,"BaoCao"),ae.writeFile(J,`Diticoms_Report_${new Date().getTime()}.xlsx`)},w=n=>{let k=`\u{1F464} Kh\xE1ch: ${n.customerName}
\u{1F4DE} S\u0110T: ${n.phone}
\u{1F4CD} \u0110\u1ECBa ch\u1EC9: ${n.address}
\u{1F4AC} Y\xEAu c\u1EA7u: ${n.content}
\u{1F527} K\u1EF9 thu\u1EADt: ${n.technician}`;navigator.clipboard.writeText(k).then(()=>{_("\u0110\xE3 ch\xE9p th\xF4ng tin!"),setTimeout(()=>_(null),2e3)})};return x("div",{className:"bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col font-sans text-sm relative overflow-hidden lg:h-full",children:[M&&x("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-[100] bg-slate-900/95 backdrop-blur-md text-white px-5 py-2.5 rounded-full flex items-center gap-2 shadow-2xl animate-in fade-in",children:[b(st,{size:16,className:"text-green-400"}),b("span",{className:"font-black text-[11px] uppercase tracking-widest",children:M})]}),x("div",{className:"space-y-3 mb-5 shrink-0",children:[x("div",{className:"relative group",children:[b(ke,{className:"absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors",size:18}),b("input",{type:"text",placeholder:"T\xECm t\xEAn, S\u0110T ho\u1EB7c \u0111\u1ECBa ch\u1EC9...",className:"w-full pl-11 pr-4 py-2.5 bg-slate-50 border border-slate-50 rounded-xl outline-none focus:bg-white focus:border-blue-100 transition-all font-medium",value:y,onChange:E})]}),x("div",{className:"flex flex-wrap items-center gap-2",children:[x("button",{onClick:()=>h.setViewAll(!c.viewAll),className:`px-3 py-1.5 rounded-xl font-bold transition-all flex items-center gap-1.5 border shadow-sm text-[11px] ${c.viewAll?"bg-blue-600 text-white border-blue-600":"bg-white text-slate-500 border-slate-200 hover:bg-slate-50"}`,children:[b(tt,{size:14})," ",c.viewAll?"T\u1EA5t c\u1EA3":"L\u1ECDc Ng\xE0y"]}),!c.viewAll&&x("div",{className:"flex items-center gap-1 bg-white rounded-xl px-2 border border-slate-200 h-[34px] shadow-sm",children:[b(et,{size:12,className:"text-slate-400"}),b("input",{type:"date",className:"bg-transparent font-bold text-slate-600 outline-none w-[88px] text-[10px]",value:c.dateFrom,onChange:n=>h.setDateFrom(n.target.value)}),b("span",{className:"text-slate-300",children:"/"}),b("input",{type:"date",className:"bg-transparent font-bold text-slate-600 outline-none w-[88px] text-[10px]",value:c.dateTo,onChange:n=>h.setDateTo(n.target.value)})]}),x("div",{className:"flex items-center gap-1 bg-white rounded-xl px-2 border border-slate-200 h-[34px] shadow-sm",children:[b(ot,{size:12,className:"text-slate-400"}),x("select",{className:"bg-transparent font-bold text-slate-600 outline-none text-[10px] border-none focus:ring-0 pr-6",value:v?c.searchTech:N?.associatedTech||"",onChange:n=>v&&h.setSearchTech(n.target.value),disabled:!v,children:[b("option",{value:"",children:"T\u1EA5t c\u1EA3 KTV"}),o.map(n=>b("option",{value:n,children:n},n))]})]}),x("button",{onClick:B,className:"h-[34px] px-3 ml-auto bg-green-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 text-[10px] uppercase shadow-sm",children:[b(rt,{size:14})," EXCEL"]})]})]}),b("div",{className:"flex-1 lg:overflow-y-auto space-y-2 pr-1 custom-scrollbar pb-2",children:r?x("div",{className:"py-12 flex flex-col items-center justify-center space-y-4",children:[b(V,{size:48,className:"animate-pulse"}),b("span",{className:"font-black text-slate-400 tracking-[0.2em] text-[10px]",children:"\u0110ANG T\u1EA2I..."})]}):e.length===0?x("div",{className:"py-12 flex flex-col items-center justify-center text-slate-300 space-y-3",children:[b(ke,{size:48,strokeWidth:1,className:"opacity-40"}),b("span",{className:"font-black uppercase tracking-widest text-[11px]",children:"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"})]}):e.map(n=>x("div",{onPointerDown:k=>{P.current=!1,F.current=!1,U.current={x:k.clientX,y:k.clientY},R.current=setTimeout(()=>{F.current||(P.current=!0,w(n))},600)},onPointerMove:k=>{Math.abs(k.clientX-U.current.x)>10&&(F.current=!0)},onPointerUp:()=>{clearTimeout(R.current),!P.current&&!F.current&&d(n)},className:`p-4 rounded-[24px] border transition-all cursor-pointer flex items-center justify-between group relative select-none touch-pan-y ${m===n.id?"bg-blue-50/80 border-blue-100 ring-2 ring-blue-50":"bg-white border-slate-50 hover:border-slate-200"}`,children:[x("div",{className:"flex gap-3.5 items-center flex-1 min-w-0",children:[x("div",{className:"h-11 w-11 bg-slate-100/50 rounded-2xl flex flex-col items-center justify-center font-bold text-slate-500 group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors text-[13px] shrink-0",children:[b("span",{children:(n.created_at||"").split("T")[0]?.split("-")[2]||"--"}),x("span",{className:"opacity-60 text-[10px]",children:["T",(n.created_at||"").split("T")[0]?.split("-")[1]||"--"]})]}),x("div",{className:"min-w-0 flex-1",children:[b("div",{className:"font-bold text-slate-800 leading-tight mb-0.5 truncate text-[14px]",children:n.customerName}),x("div",{className:"flex items-center gap-1.5 text-[10px] text-slate-500 font-medium mb-1.5",children:[b(at,{size:10,className:"text-blue-400"})," ",n.phone,b("span",{className:"text-slate-200",children:"|"}),b(nt,{size:10,className:"text-red-400"})," ",b("span",{className:"truncate",children:n.address||"Kh\xF4ng \u0111\u1ECBa ch\u1EC9"})]}),x("div",{className:"flex items-center gap-2",children:[b("span",{className:"font-black text-slate-400 uppercase tracking-tighter text-[10px] truncate max-w-[90px]",children:n.technician||"CH\u01AFA PH\xC2N C\xD4NG"}),b("span",{className:`font-black px-2 py-0.5 rounded-lg uppercase tracking-widest text-[9px] ${n.status==="Ho\xE0n th\xE0nh"?"bg-green-100 text-green-600":n.status==="Ch\u01B0a thanh to\xE1n"?"bg-red-100 text-red-600":"bg-blue-100 text-blue-600"}`,children:n.status})]})]})]}),x("div",{className:"flex items-center gap-3 shrink-0 ml-3",children:[x("div",{className:"text-right",children:[x("div",{className:"font-black text-slate-800 text-[14px]",children:[H(n.revenue),"\u0111"]}),Number(n.debt)>0&&x("div",{className:"font-black text-red-500 text-[10px]",children:["N\u1EE3: ",H(n.debt)]})]}),b(Ze,{size:18,className:"text-slate-200 group-hover:text-blue-400"})]})]},n.id))}),x("div",{className:"mt-2 pt-4 border-t border-slate-50 flex justify-between items-center px-1 shrink-0",children:[x("span",{className:"font-black text-slate-400 uppercase tracking-widest text-[10px]",children:["S\u1ED1 l\u01B0\u1EE3ng: ",b("span",{className:"text-slate-700",children:e.length})]}),x("span",{className:"font-black text-blue-600 bg-blue-50 px-4 py-2 rounded-2xl uppercase tracking-[0.1em] border border-blue-100 text-[11px] shadow-sm",children:["T\u1ED5ng thu: ",H(e.reduce((n,k)=>n+Number(k.revenue||0),0)),"\u0111"]})]})]})};import{useState as se,useRef as it,useMemo as ge}from"react";import{Plus as ct,Trash2 as ze,Activity as dt,User as pt,Phone as ut,MapPin as mt,ReceiptText as bt,Share2 as ht,MessageSquare as gt,Sparkles as Re,Loader2 as Pe,Camera as xt,ArrowLeft as ft,RefreshCw as vt}from"lucide-react";import Nt from"html2canvas";var he="https://script.google.com/macros/s/AKfycbydOG7vnrXSXF6o0tLU843G_P2Jl9iOCcyuGAI7gRqhLrgmCvMgGj84HKPcfLFf1ZJL/exec",Ce={sheetUrl:he,bankInfo:{bankId:"TCB",accountNo:"7929499999",accountName:"NGUYEN PHUOC DUC"}},te=["Ti\u1EBFp nh\u1EADn","\u0110ang s\u1EEDa ch\u1EEFa","Ch\u01B0a thanh to\xE1n","Ho\xE0n th\xE0nh"];import{jsx as g,jsxs as L}from"react/jsx-runtime";var Te=({formData:e,bankInfo:r})=>{let o=Number(e.revenue||0),m=r?`https://img.vietqr.io/image/${r.bankId}-${r.accountNo}-compact2.png?amount=${o}&addInfo=${encodeURIComponent(`DITICOMS ${e.customerName.toUpperCase()}`)}&accountName=${encodeURIComponent(r.accountName)}`:"";return L("div",{className:"w-[302px] bg-white p-6 mx-auto font-sans block",style:{height:"auto",minHeight:"fit-content"},children:[L("div",{className:"flex flex-col items-center text-center space-y-1 mb-5",children:[g(V,{size:52}),g("h1",{className:"text-xl font-black uppercase text-blue-600 tracking-tight",children:"DITICOMS SERVICE"}),g("p",{className:"text-[10px] text-slate-800 font-black uppercase tracking-widest",children:"Hotline: 0935.71.5151"}),g("div",{className:"w-12 h-0.5 bg-blue-600 rounded-full mt-1.5"})]}),L("div",{className:"space-y-1.5 mb-5 text-[11px]",children:[L("div",{className:"flex justify-between border-b border-slate-50 pb-1 gap-2",children:[g("span",{className:"font-bold text-slate-400 uppercase text-[9px] shrink-0",children:"Kh\xE1ch h\xE0ng:"}),g("span",{className:"font-bold text-slate-900 text-right",children:e.customerName})]}),L("div",{className:"flex justify-between border-b border-slate-50 pb-1 gap-2",children:[g("span",{className:"font-bold text-slate-400 uppercase text-[9px] shrink-0",children:"\u0110i\u1EC7n tho\u1EA1i:"}),g("span",{className:"font-bold text-slate-900 text-right",children:e.phone})]}),e.address&&L("div",{className:"flex justify-between border-b border-slate-50 pb-1 gap-2",children:[g("span",{className:"font-bold text-slate-400 uppercase text-[9px] shrink-0",children:"\u0110\u1ECBa ch\u1EC9:"}),g("span",{className:"font-bold text-slate-900 text-right truncate max-w-[180px]",children:e.address})]}),L("div",{className:"flex justify-between border-b border-slate-50 pb-1",children:[g("span",{className:"font-bold text-slate-400 uppercase text-[9px]",children:"Ng\xE0y in:"}),g("span",{className:"font-bold text-slate-900",children:new Date().toLocaleDateString("vi-VN")})]})]}),L("div",{className:"space-y-3 mb-6",children:[g("div",{className:"text-[9px] font-black text-slate-400 uppercase tracking-widest border-l-2 border-blue-500 pl-2",children:"Chi ti\u1EBFt d\u1ECBch v\u1EE5"}),L("table",{className:"w-full text-[10px] border-collapse",children:[g("thead",{children:L("tr",{className:"text-[8px] text-slate-400 uppercase border-b border-slate-100",children:[g("th",{className:"pb-2 text-left font-black",children:"N\u1ED9i dung"}),g("th",{className:"pb-2 text-center font-black px-1",children:"SL"}),g("th",{className:"pb-2 text-right font-black",children:"T.Ti\u1EC1n"})]})}),g("tbody",{className:"divide-y divide-slate-50",children:e.workItems.map((d,c)=>L("tr",{className:"align-middle",children:[g("td",{className:"py-2.5 text-slate-800 font-bold leading-tight pr-1",children:d.desc}),g("td",{className:"py-2.5 text-center text-slate-600 font-black px-1",children:d.qty}),g("td",{className:"py-2.5 text-right font-black text-slate-900 whitespace-nowrap",children:H(d.total)})]},c))})]})]}),L("div",{className:"bg-slate-50 p-4 rounded-2xl flex justify-between items-center mb-6",children:[g("span",{className:"text-[10px] font-black text-slate-500 uppercase tracking-wider",children:"T\u1ED5ng c\u1ED9ng:"}),L("span",{className:"text-lg font-black text-blue-600",children:[H(e.revenue),"\u0111"]})]}),r&&o>0&&L("div",{className:"flex flex-col items-center space-y-3 pt-4 border-t border-dashed border-slate-200",children:[g("div",{className:"bg-white p-2 rounded-xl border-2 border-slate-100 shadow-sm inline-block",children:g("img",{src:m,alt:"QR",className:"w-36 h-36 aspect-square object-contain mx-auto",crossOrigin:"anonymous"})}),L("div",{className:"text-center",children:[L("p",{className:"text-[10px] font-black text-slate-800 uppercase tracking-tighter",children:[r.bankId," \u2022 ",r.accountNo]}),g("p",{className:"text-[8px] font-bold text-slate-400 uppercase mt-0.5",children:r.accountName})]})]}),g("div",{className:"text-center pt-6 border-t border-slate-50 mt-6",children:g("p",{className:"text-[9px] font-bold text-slate-400 uppercase italic tracking-widest",children:"Tr\xE2n tr\u1ECDng c\u1EA3m \u01A1n!"})})]})};import{GoogleGenAI as lt,Type as q}from"@google/genai";var Ie=()=>new lt({apiKey:process.env.API_KEY}),Ae=async e=>{if(!e||e.length<5)throw new Error("M\xF4 t\u1EA3 qu\xE1 ng\u1EAFn \u0111\u1EC3 AI c\xF3 th\u1EC3 ch\u1EA9n \u0111o\xE1n.");let o=await Ie().models.generateContent({model:"gemini-3-flash-preview",contents:`Kh\xE1ch h\xE0ng b\xE1o l\u1ED7i: "${e}". H\xE3y ph\xE2n t\xEDch l\u1ED7i k\u1EF9 thu\u1EADt n\xE0y v\xE0 \u0111\u1EC1 xu\u1EA5t c\xE1c d\u1ECBch v\u1EE5 ho\u1EB7c linh ki\u1EC7n thay th\u1EBF k\xE8m \u0111\u01A1n gi\xE1 ph\xF9 h\u1EE3p t\u1EA1i th\u1ECB tr\u01B0\u1EDDng Vi\u1EC7t Nam hi\u1EC7n nay.`,config:{responseMimeType:"application/json",responseSchema:{type:q.OBJECT,properties:{suggestions:{type:q.ARRAY,items:{type:q.OBJECT,properties:{desc:{type:q.STRING,description:"T\xEAn linh ki\u1EC7n ho\u1EB7c d\u1ECBch v\u1EE5 \u0111\u1EC1 xu\u1EA5t"},qty:{type:q.NUMBER,description:"S\u1ED1 l\u01B0\u1EE3ng"},price:{type:q.NUMBER,description:"\u0110\u01A1n gi\xE1 d\u1EF1 ki\u1EBFn (VN\u0110)"}},required:["desc","qty","price"]}}},required:["suggestions"]},systemInstruction:"B\u1EA1n l\xE0 m\u1ED9t chuy\xEAn gia s\u1EEDa ch\u1EEFa m\xE1y t\xEDnh v\xE0 thi\u1EBFt b\u1ECB \u0111i\u1EC7n t\u1EED c\u1EE7a Diticoms. B\u1EA1n ch\u1EC9 tr\u1EA3 v\u1EC1 d\u1EEF li\u1EC7u d\u01B0\u1EDBi d\u1EA1ng JSON \u0111\u1EC3 h\u1EC7 th\u1ED1ng t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n v\xE0o h\xF3a \u0111\u01A1n."}});try{let m=o.text||"{}";return JSON.parse(m).suggestions||[]}catch(m){return console.error("L\u1ED7i ph\xE2n t\xEDch JSON t\u1EEB AI:",m),[]}},Le=async(e,r)=>{let o=Ie(),m=r.map(c=>({khach_hang:c.customerName,ngay:c.created_at?.split("T")[0],trang_thai:c.status,ky_thuat:c.technician,doanh_thu:Number(c.revenue||0),noi_dung:c.content})),d=await o.models.generateContent({model:"gemini-3-flash-preview",contents:`C\xE2u h\u1ECFi t\u1EEB qu\u1EA3n l\xFD: "${e}"

D\u1EEF li\u1EC7u phi\u1EBFu d\u1ECBch v\u1EE5 hi\u1EC7n c\xF3: ${JSON.stringify(m.slice(0,50))}`,config:{responseMimeType:"application/json",responseSchema:{type:q.OBJECT,properties:{answer:{type:q.STRING,description:"C\xE2u tr\u1EA3 l\u1EDDi ph\xE2n t\xEDch ho\u1EB7c th\u1ED1ng k\xEA"},filterUpdate:{type:q.OBJECT,properties:{searchTerm:{type:q.STRING,description:"T\u1EEB kh\xF3a c\u1EA7n t\xECm n\u1EBFu ng\u01B0\u1EDDi d\xF9ng y\xEAu c\u1EA7u l\u1ECDc"},status:{type:q.STRING,description:"Tr\u1EA1ng th\xE1i c\u1EA7n l\u1ECDc"},viewAll:{type:q.BOOLEAN,description:"B\u1EADt ch\u1EBF \u0111\u1ED9 xem t\u1EA5t c\u1EA3 n\u1EBFu c\u1EA7n"}}}},required:["answer"]},systemInstruction:"B\u1EA1n l\xE0 tr\u1EE3 l\xFD d\u1EEF li\u1EC7u th\xF4ng minh c\u1EE7a Diticoms. B\u1EA1n gi\xFAp nh\xE2n vi\xEAn th\u1ED1ng k\xEA doanh thu, t\xECm ki\u1EBFm kh\xE1ch h\xE0ng ho\u1EB7c l\u1ECDc tr\u1EA1ng th\xE1i c\xF4ng vi\u1EC7c. Tr\u1EA3 l\u1EDDi ng\u1EAFn g\u1ECDn, chuy\xEAn nghi\u1EC7p."}});try{let c=d.text||"{}";return JSON.parse(c)}catch{return{answer:"Xin l\u1ED7i, t\xF4i g\u1EB7p tr\u1EE5c tr\u1EB7c khi truy xu\u1EA5t d\u1EEF li\u1EC7u."}}};import{Fragment as Ue,jsx as a,jsxs as p}from"react/jsx-runtime";var Oe=({formData:e,setFormData:r,technicians:o,priceList:m,selectedId:d,isSubmitting:c,currentUser:h,onSave:N,onUpdate:v,onDelete:y,onClear:z,services:M,bankInfo:_})=>{let R=h?.role==="admin",[P,U]=se(!1),[F,Q]=se(!1),[E,B]=se(!1),[w,n]=se(null),[k,J]=se(null),[S,re]=se(null),[s,i]=se(!1),f=it(null),$=ge(()=>{if(k===null)return[];let t=(e.workItems[k]?.desc||"").toLowerCase();return t?m.filter(l=>l.name.toLowerCase().includes(t)).slice(0,5):[]},[m,e.workItems,k]),C=ge(()=>{let t={};return Array.isArray(M)&&M.forEach(l=>{let u=String(l.phone||"").trim();u.length>=3&&!t[u]&&(t[u]={name:l.customerName||"",address:l.address||""})}),Object.entries(t).map(([l,u])=>({phone:l,...u}))},[M]),Z=ge(()=>{let t=(e.phone||"").trim();return t.length<3?[]:C.filter(l=>l.phone.includes(t)).slice(0,5)},[C,e.phone]),D=(t,l)=>{r(u=>{let T={...u,[t]:l};return t==="status"&&(T.debt=l==="Ho\xE0n th\xE0nh"?0:u.revenue),T})},xe=t=>{r(l=>({...l,phone:t.phone,customerName:t.name,address:t.address})),U(!1)},$e=(t,l)=>{oe(t,"desc",l.name),oe(t,"price",l.price),J(null)},oe=(t,l,u)=>{r(T=>{let K=Array.isArray(T.workItems)?[...T.workItems]:[];if(!K[t])return T;let le={...K[t],[l]:u},Ge=ie(l==="price"?u:le.price),Xe=Number(l==="qty"?u:le.qty);le.total=Ge*Xe,K[t]=le;let fe=K.reduce((Je,Ke)=>Je+(Number(Ke.total)||0),0);return{...T,workItems:K,revenue:fe,debt:T.status==="Ho\xE0n th\xE0nh"?0:fe}})},qe=async()=>{if(!e.content)return pe("Vui l\xF2ng nh\u1EADp n\u1ED9i dung l\u1ED7i");i(!0);try{let t=await Ae(e.content);if(t&&t.length>0){let l=t.map(T=>({...T,total:T.qty*T.price})),u=l.reduce((T,K)=>T+K.total,0);r(T=>({...T,workItems:l,revenue:u,debt:T.status==="Ho\xE0n th\xE0nh"?0:u})),pe("AI \u0111\xE3 b\xE1o gi\xE1 ho\xE0n t\u1EA5t!")}}catch(t){alert(t.message)}finally{i(!1)}},Be=async()=>{if(f.current){B(!0);try{await new Promise(l=>setTimeout(l,800));let t=await Nt(f.current,{scale:2,useCORS:!0,backgroundColor:"#ffffff",logging:!1});n(t.toDataURL("image/png")),pe("\u0110\xE3 t\u1EA1o \u1EA3nh h\xF3a \u0111\u01A1n!")}catch{alert("L\u1ED7i khi t\u1EA1o \u1EA3nh h\xF3a \u0111\u01A1n.")}finally{B(!1)}}},pe=t=>{re(t),setTimeout(()=>re(null),3e3)},ue="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-100 rounded-xl outline-none focus:bg-white focus:border-blue-400 font-medium transition-all text-slate-800",me="w-full p-2 bg-white border border-slate-100 rounded-xl outline-none focus:border-blue-400 font-black text-slate-800 text-[10px] text-center";return p("div",{className:"space-y-6",children:[S&&p("div",{className:"fixed top-24 left-1/2 -translate-x-1/2 z-[10001] bg-slate-900/90 backdrop-blur-md text-white px-6 py-3 rounded-full text-[11px] font-black uppercase tracking-widest animate-in fade-in zoom-in shadow-2xl flex items-center gap-2",children:[a(Re,{size:14,className:"text-yellow-400"})," ",S]}),p("div",{className:"flex justify-between items-center",children:[p("h2",{className:"font-bold text-slate-700 flex items-center gap-2 uppercase tracking-wider text-sm",children:[a(dt,{size:18,className:"text-blue-500"})," ",d?"C\u1EADp nh\u1EADt phi\u1EBFu":"Ti\u1EBFp nh\u1EADn m\u1EDBi"]}),p("div",{className:"flex gap-1",children:[d&&a("button",{onClick:z,className:"p-2 text-slate-400 hover:bg-slate-50 rounded-full",children:a(vt,{size:18})}),d&&R&&a("button",{onClick:y,disabled:c,className:"text-red-400 p-2 hover:bg-red-50 rounded-full transition-colors",children:a(ze,{size:20})})]})]}),p("div",{className:"space-y-3",children:[p("div",{className:"relative",children:[a(ut,{className:"absolute left-3.5 top-3 text-slate-400 z-10",size:16}),a("input",{type:"tel",placeholder:"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i",className:ue,value:e.phone||"",onChange:t=>{D("phone",t.target.value),U(!0)},onFocus:()=>U(!0),onBlur:()=>setTimeout(()=>U(!1),200)}),P&&Z.length>0&&a("div",{className:"absolute top-full left-0 right-0 bg-white border border-slate-200 shadow-2xl z-[60] max-h-56 overflow-auto rounded-2xl mt-1",children:Z.map((t,l)=>p("div",{onMouseDown:()=>xe(t),className:"p-3 hover:bg-blue-50 cursor-pointer border-b last:border-0 transition-colors flex justify-between",children:[a("span",{className:"font-black text-blue-600 text-xs",children:t.phone}),a("span",{className:"font-bold text-slate-800 text-xs",children:t.name})]},l))})]}),p("div",{className:"relative",children:[a(pt,{className:"absolute left-3.5 top-3 text-slate-400 z-10",size:16}),a("input",{type:"text",placeholder:"T\xEAn kh\xE1ch h\xE0ng",className:ue,value:e.customerName||"",onChange:t=>D("customerName",t.target.value)})]}),p("div",{className:"relative",children:[a(mt,{className:"absolute left-3.5 top-3 text-slate-400 z-10",size:16}),a("input",{type:"text",placeholder:"\u0110\u1ECBa ch\u1EC9",className:ue,value:e.address||"",onChange:t=>D("address",t.target.value)})]}),p("div",{className:"relative group",children:[a(gt,{className:"absolute left-3.5 top-3.5 text-slate-400 z-10",size:16}),a("textarea",{placeholder:"M\xF4 t\u1EA3 l\u1ED7i ho\u1EB7c y\xEAu c\u1EA7u kh\xE1ch h\xE0ng...",className:"w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-xl min-h-[100px] focus:bg-white focus:border-blue-400 outline-none transition-all",value:e.content||"",onChange:t=>D("content",t.target.value)}),p("button",{onClick:qe,disabled:s||!e.content,className:`absolute right-3 bottom-3 flex items-center gap-2 px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-wider transition-all shadow-md ${s?"bg-slate-200 text-slate-400":"bg-gradient-to-r from-purple-600 to-indigo-600 text-white"}`,children:[s?a(Pe,{size:14,className:"animate-spin"}):a(Re,{size:14})," AI B\xC1O GI\xC1"]})]}),p("div",{className:"grid grid-cols-2 gap-3",children:[a("select",{className:"w-full p-2.5 bg-slate-50 border border-slate-100 rounded-xl font-bold text-slate-700 outline-none",value:e.status,onChange:t=>D("status",t.target.value),children:te.map(t=>a("option",{value:t,children:t},t))}),p("select",{className:"w-full p-2.5 bg-slate-50 border border-slate-100 rounded-xl font-bold text-slate-700 outline-none disabled:opacity-50",value:e.technician||"",onChange:t=>D("technician",t.target.value),disabled:!R,children:[a("option",{value:"",children:"K\u1EF9 thu\u1EADt vi\xEAn"}),o.map(t=>a("option",{value:t,children:t},t))]})]}),p("div",{className:"pt-2",children:[p("div",{className:"flex justify-between items-center mb-2 px-1",children:[a("span",{className:"font-black text-slate-400 text-[10px] uppercase tracking-widest",children:"D\u1ECBch v\u1EE5 & Linh ki\u1EC7n"}),a("button",{onClick:()=>r(t=>({...t,workItems:Array.isArray(t.workItems)?[...t.workItems,{desc:"",qty:1,price:"",total:0}]:[{desc:"",qty:1,price:"",total:0}]})),className:"text-blue-500 p-1 hover:bg-blue-50 rounded-lg",children:a(ct,{size:18})})]}),a("div",{className:"space-y-2",children:Array.isArray(e.workItems)&&e.workItems.map((t,l)=>p("div",{className:"p-3 bg-slate-50/50 border border-slate-100 rounded-2xl space-y-2 group hover:border-blue-100 transition-all relative",children:[a("input",{type:"text",placeholder:"T\xEAn d\u1ECBch v\u1EE5...",className:"w-full bg-transparent font-bold text-slate-800 outline-none border-b border-transparent focus:border-blue-200 text-[13px]",value:t.desc||"",onChange:u=>{oe(l,"desc",u.target.value),J(l)},onFocus:()=>J(l),onBlur:()=>setTimeout(()=>J(null),200)}),k===l&&$.length>0&&a("div",{className:"absolute top-10 left-0 right-0 bg-white border border-slate-200 shadow-2xl z-[60] max-h-48 overflow-auto rounded-xl mt-1",children:$.map((u,T)=>p("div",{onMouseDown:()=>$e(l,u),className:"p-2.5 hover:bg-blue-50 cursor-pointer border-b last:border-0 transition-colors flex justify-between items-center",children:[a("span",{className:"font-bold text-slate-800 text-[11px]",children:u.name}),a("span",{className:"font-black text-blue-600 text-[10px]",children:H(u.price)})]},T))}),p("div",{className:"flex gap-2 text-[11px] font-bold",children:[p("div",{className:"flex-1 bg-white border border-slate-100 p-1.5 rounded-lg flex items-center gap-1",children:["SL: ",a("input",{type:"number",className:"w-full outline-none font-black text-center bg-transparent",value:t.qty||1,onChange:u=>oe(l,"qty",u.target.value)})]}),a("div",{className:"flex-[2] bg-white border border-slate-100 p-1.5 rounded-lg px-2 text-right",children:a("input",{type:"text",className:"w-full outline-none font-black text-right text-blue-600 bg-transparent",value:H(t.price),onChange:u=>oe(l,"price",u.target.value)})}),a("button",{onClick:()=>r(u=>({...u,workItems:u.workItems.filter((T,K)=>K!==l)})),className:"text-slate-300 hover:text-red-400 p-1",children:a(ze,{size:16})})]})]},l))})]}),p("div",{className:"pt-4 grid grid-cols-3 gap-3 bg-slate-100/40 p-4 rounded-[32px] border border-slate-100",children:[p("div",{className:"text-center",children:[a("span",{className:"text-[9px] font-black text-blue-500 uppercase",children:"Doanh thu"}),a("input",{type:"text",className:`${me} text-blue-600`,value:H(e.revenue),readOnly:!0})]}),p("div",{className:"text-center",children:[a("span",{className:"text-[9px] font-black text-orange-500 uppercase",children:"Gi\xE1 v\u1ED1n"}),a("input",{type:"text",className:`${me} text-orange-600`,value:H(e.cost),onChange:t=>D("cost",ie(t.target.value))})]}),p("div",{className:"text-center",children:[a("span",{className:"text-[9px] font-black text-red-500 uppercase",children:"C\xF4ng n\u1EE3"}),a("input",{type:"text",className:`${me} text-red-600`,value:H(e.debt),onChange:t=>D("debt",ie(t.target.value))})]})]})]}),a("div",{className:"grid grid-cols-2 gap-3 pt-4",children:d?p(Ue,{children:[a("button",{disabled:c,onClick:v,className:"bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-[12px] active:scale-95 transition-all",children:"C\u1EACP NH\u1EACT"}),a("button",{onClick:z,className:"bg-slate-100 text-slate-600 font-black py-4 rounded-2xl uppercase text-[12px] active:scale-95 transition-all",children:"TI\u1EBEP M\u1EDAI"})]}):a("button",{disabled:c,onClick:N,className:"col-span-2 bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-lg uppercase tracking-widest text-[12px] active:scale-95 transition-all",children:c?"\u0110ANG L\u01AFU...":"L\u01AFU PHI\u1EBEU M\u1EDAI"})}),d&&p("button",{onClick:()=>{Q(!0),n(null)},className:"w-full bg-slate-800 hover:bg-slate-900 text-white font-black py-4 rounded-2xl uppercase shadow-md flex items-center justify-center gap-3 text-[12px] transition-all",children:[a(bt,{size:20})," XU\u1EA4T H\xD3A \u0110\u01A0N"]}),F&&a("div",{className:"fixed inset-0 z-[10000] bg-black/90 flex flex-col p-4 animate-in fade-in",children:p("div",{className:"max-w-md w-full mx-auto flex flex-col h-full",children:[p("div",{className:"flex justify-between items-center mb-6",children:[p("button",{onClick:()=>Q(!1),className:"flex items-center gap-2 text-white/70 font-bold uppercase text-[10px] tracking-widest hover:text-white transition-colors",children:[a(ft,{size:16})," Quay l\u1EA1i"]}),a("h3",{className:"text-white font-black uppercase tracking-[0.2em] text-xs",children:"H\xF3a \u0111\u01A1n \u0111i\u1EC7n t\u1EED"}),a("div",{className:"w-10"})]}),a("div",{className:"flex-1 overflow-y-auto custom-scrollbar bg-slate-100 rounded-[40px] p-4 shadow-2xl flex flex-col items-center",children:w?p("div",{className:"animate-in zoom-in duration-300 w-full flex flex-col items-center px-2",children:[a("img",{src:w,alt:"Invoice",className:"w-full rounded-2xl shadow-xl border border-white/50 mb-8"}),p("div",{className:"w-full space-y-3 pb-8",children:[p("button",{onClick:async()=>{let t=await(await fetch(w)).blob(),l=new File([t],`Bill_${e.customerName}.png`,{type:"image/png"});if(navigator.share&&navigator.canShare?.({files:[l]}))await navigator.share({files:[l],title:"H\xF3a \u0111\u01A1n Diticoms",text:`G\u1EEDi h\xF3a \u0111\u01A1n cho ${e.customerName}`});else{let u=document.createElement("a");u.download=`Bill_${e.customerName}.png`,u.href=w,u.click()}},className:"w-full bg-blue-600 text-white font-black py-5 rounded-3xl uppercase tracking-widest flex items-center justify-center gap-3 shadow-lg active:scale-95 transition-all",children:[a(ht,{size:20})," CHIA S\u1EBA NGAY"]}),a("button",{onClick:()=>n(null),className:"w-full text-slate-400 font-bold py-3 uppercase text-[10px] tracking-widest",children:"QUAY L\u1EA0I CH\u1EC8NH S\u1EECA"})]})]}):p(Ue,{children:[a("div",{ref:f,className:"bg-white rounded-3xl overflow-hidden shadow-sm p-1",children:a(Te,{formData:e,bankInfo:_})}),a("div",{className:"w-full mt-8 px-4",children:p("button",{onClick:Be,disabled:E,className:"w-full bg-blue-600 text-white font-black py-5 rounded-3xl uppercase tracking-widest flex items-center justify-center gap-4 shadow-2xl active:scale-95 transition-all",children:[E?a(Pe,{size:24,className:"animate-spin"}):a(xt,{size:24})," T\u1EA0O \u1EA2NH CHIA S\u1EBA"]})})]})})]})})]})};import{useState as wt}from"react";import{X as yt,Save as kt,CreditCard as St,RefreshCw as Ct,Loader2 as Tt}from"lucide-react";import{jsx as j,jsxs as W}from"react/jsx-runtime";var _e=({config:e,onSave:r,onClose:o,isAdmin:m,onCheckUpdate:d,isCheckingUpdate:c})=>{let[h,N]=wt({...e});return j("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4",children:W("div",{className:"bg-white rounded-3xl p-6 max-w-md w-full shadow-2xl space-y-6",children:[W("div",{className:"flex justify-between items-center",children:[j("h3",{className:"font-black text-slate-900 uppercase tracking-tight",children:"C\u1EA5u h\xECnh h\u1EC7 th\u1ED1ng"}),j("button",{onClick:o,className:"p-2 bg-slate-100 rounded-full text-slate-400 hover:text-slate-600",children:j(yt,{size:20})})]}),W("div",{className:"space-y-4",children:[W("div",{className:"space-y-3",children:[W("label",{className:"text-[10px] font-bold text-slate-400 uppercase ml-1 flex items-center gap-2",children:[j(St,{size:12})," Th\xF4ng tin ng\xE2n h\xE0ng"]}),W("div",{className:"grid grid-cols-2 gap-3",children:[j("input",{placeholder:"ID Ng\xE2n h\xE0ng",className:"p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-blue-500 text-xs",value:h.bankInfo?.bankId,onChange:v=>N(y=>({...y,bankInfo:{...y.bankInfo,bankId:v.target.value}}))}),j("input",{placeholder:"S\u1ED1 t\xE0i kho\u1EA3n",className:"p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-blue-500 text-xs",value:h.bankInfo?.accountNo,onChange:v=>N(y=>({...y,bankInfo:{...y.bankInfo,accountNo:v.target.value}}))}),j("input",{placeholder:"Ch\u1EE7 t\xE0i kho\u1EA3n",className:"col-span-2 p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-blue-500 text-xs",value:h.bankInfo?.accountName,onChange:v=>N(y=>({...y,bankInfo:{...y.bankInfo,accountName:v.target.value.toUpperCase()}}))})]})]}),d&&j("div",{className:"pt-2",children:W("button",{onClick:d,disabled:c,className:"w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-2xl text-[10px] font-bold uppercase transition-colors",children:[c?j(Tt,{size:14,className:"animate-spin"}):j(Ct,{size:14}),"Ki\u1EC3m tra c\u1EADp nh\u1EADt t\u1EEB GitHub"]})})]}),W("div",{className:"flex gap-3",children:[W("button",{onClick:()=>r(h),className:"flex-1 bg-blue-600 text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-blue-100",children:[j(kt,{size:18})," L\u01AFU C\u1EA4U H\xCCNH"]}),j("button",{onClick:o,className:"px-6 bg-slate-100 text-slate-600 font-bold rounded-2xl",children:"H\u1EE6Y"})]})]})})};import{useState as de,useRef as It,useEffect as At}from"react";import{Send as Lt,X as Ee,Sparkles as zt,Loader2 as Rt,Bot as Pt}from"lucide-react";import{Fragment as Ut,jsx as I,jsxs as X}from"react/jsx-runtime";var De=({services:e,onApplyFilter:r})=>{let[o,m]=de(!1),[d,c]=de(""),[h,N]=de([{role:"bot",text:"Ch\xE0o b\u1EA1n! T\xF4i c\xF3 th\u1EC3 gi\xFAp b\u1EA1n t\xECm ki\u1EBFm kh\xE1ch h\xE0ng, l\u1ECDc tr\u1EA1ng th\xE1i ho\u1EB7c th\u1ED1ng k\xEA doanh thu nhanh ch\xF3ng. B\u1EA1n c\u1EA7n g\xEC?"}]),[v,y]=de(!1),z=It(null);At(()=>{z.current&&(z.current.scrollTop=z.current.scrollHeight)},[h,v]);let M=async _=>{if(_?.preventDefault(),!d.trim()||v)return;let R=d.trim();N(P=>[...P,{role:"user",text:R}]),c(""),y(!0);try{let P=await Le(R,e);N(U=>[...U,{role:"bot",text:P.answer}]),P.filterUpdate&&r(P.filterUpdate)}catch(P){N(U=>[...U,{role:"bot",text:"L\u1ED7i k\u1EBFt n\u1ED1i AI: "+P.message}])}finally{y(!1)}};return X("div",{className:"fixed bottom-6 right-6 z-[100] flex flex-col items-end",children:[o&&X("div",{className:"w-[340px] h-[480px] bg-white rounded-[32px] shadow-2xl border border-slate-100 flex flex-col mb-4 animate-in slide-in-from-bottom overflow-hidden",children:[X("div",{className:"bg-blue-600 p-5 text-white flex justify-between items-center shrink-0",children:[X("div",{className:"flex items-center gap-3",children:[I("div",{className:"p-2 bg-white/20 rounded-xl",children:I(zt,{size:18})}),X("div",{children:[I("h3",{className:"font-black text-xs uppercase tracking-widest",children:"DITI AI Assistant"}),X("div",{className:"flex items-center gap-1.5 mt-0.5",children:[I("div",{className:"w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"}),I("span",{className:"text-[9px] font-bold text-blue-100 uppercase",children:"S\u1EB5n s\xE0ng h\u1ED7 tr\u1EE3"})]})]})]}),I("button",{onClick:()=>m(!1),className:"p-2 hover:bg-black/10 rounded-full transition-colors",children:I(Ee,{size:20})})]}),X("div",{ref:z,className:"flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50 custom-scrollbar",children:[h.map((_,R)=>I("div",{className:`flex ${_.role==="user"?"justify-end":"justify-start"}`,children:I("div",{className:`max-w-[85%] p-3.5 rounded-2xl text-[12px] font-medium shadow-sm leading-relaxed ${_.role==="user"?"bg-blue-600 text-white rounded-br-none":"bg-white text-slate-800 border border-slate-100 rounded-bl-none"}`,children:_.text})},R)),v&&I("div",{className:"flex justify-start",children:X("div",{className:"bg-white border border-slate-100 p-3.5 rounded-2xl rounded-bl-none flex items-center gap-3",children:[I(Rt,{size:14,className:"animate-spin text-blue-600"}),I("span",{className:"text-[11px] font-black text-slate-400 uppercase tracking-widest",children:"\u0110ang ph\xE2n t\xEDch..."})]})})]}),X("form",{onSubmit:M,className:"p-4 bg-white border-t border-slate-50 flex gap-2",children:[I("input",{type:"text",placeholder:"Nh\u1EADp y\xEAu c\u1EA7u (VD: Th\u1ED1ng k\xEA doanh thu)",className:"flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 text-xs font-medium focus:ring-2 focus:ring-blue-500/20 transition-all outline-none",value:d,onChange:_=>c(_.target.value),disabled:v}),I("button",{type:"submit",disabled:v||!d.trim(),className:"bg-blue-600 text-white p-3 rounded-xl shadow-lg shadow-blue-100 active:scale-90 transition-all disabled:opacity-50",children:I(Lt,{size:18})})]})]}),I("button",{onClick:()=>m(!o),className:`w-14 h-14 rounded-full flex items-center justify-center shadow-2xl transition-all active:scale-90 group relative ${o?"bg-slate-800 text-white":"bg-blue-600 text-white hover:bg-blue-700"}`,children:o?I(Ee,{size:24}):X(Ut,{children:[I(Pt,{size:28}),I("div",{className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full border-2 border-white flex items-center justify-center text-[10px] font-bold",children:"1"})]})})]})};async function Y(e,r,o={},m=0){if(!e||!e.startsWith("http"))throw new Error("C\u1EA5u h\xECnh URL Server kh\xF4ng h\u1EE3p l\u1EC7.");try{let h=new AbortController,N=setTimeout(()=>h.abort(),2e4),v=await fetch(e,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({...o,action:r}),signal:h.signal});if(clearTimeout(N),!v.ok)throw new Error(`HTTP ${v.status}`);let y=await v.text();if(!y)throw new Error("Server ph\u1EA3n h\u1ED3i r\u1ED7ng.");let z=y.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);return JSON.parse(z?z[0]:y)}catch(h){if(m<1&&(h.name==="AbortError"||h.message.includes("HTTP")))return Y(e,r,o,m+1);throw h}}import{jsx as A,jsxs as ne}from"react/jsx-runtime";var Mt=()=>{let[e,r]=G(()=>{let s=localStorage.getItem("diti_user");return s?JSON.parse(s):null}),[o,m]=G(()=>{let s=localStorage.getItem("diti_config");return{...s?JSON.parse(s):Ce,sheetUrl:he}}),[d,c]=G(()=>{let s=localStorage.getItem("diti_services_cache");return s?JSON.parse(s):[]}),[h,N]=G([]),[v,y]=G([]),[z,M]=G(!1),[_,R]=G(!1),[P,U]=G(!1),[F,Q]=G(null),[E,B]=G({dateFrom:be(),dateTo:be(),searchTerm:"",searchTech:"",viewAll:!1}),[w,n]=G({customerName:"",phone:"",address:"",status:te[0],technician:"",content:"",workItems:[{desc:"",qty:1,price:"",total:0}],revenue:0,cost:0,debt:0}),k=Me(async()=>{if(e){M(d.length===0);try{let[s,i,f]=await Promise.all([Y(o.sheetUrl,"read"),Y(o.sheetUrl,"read_settings"),Y(o.sheetUrl,"read_pricelist")]);if(Array.isArray(s)){let $=s.map(C=>{let Z=[],D=C.work_items||C.workItems;if(Array.isArray(D))Z=D;else if(typeof D=="string"&&D.trim().startsWith("["))try{Z=JSON.parse(D)}catch{Z=[]}return{id:String(C.id),created_at:C.created_at||C.date||new Date().toISOString(),customerName:C.customer_name||C.customerName||"",phone:String(C.phone||"").replace(/^'/,""),address:C.address||"",status:C.status||te[0],technician:C.technician||"",content:C.content||"",workItems:Z,revenue:Number(C.revenue||0),cost:Number(C.cost||0),debt:Number(C.debt||0)}});c($),localStorage.setItem("diti_services_cache",JSON.stringify($))}if(i?.technicians){let $=typeof i.technicians=="string"?JSON.parse(i.technicians):i.technicians;N(Array.isArray($)?$:[])}Array.isArray(f)&&y(f)}catch(s){console.error("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u:",s)}finally{M(!1)}}},[e,o.sheetUrl,d.length]);Ot(()=>{e&&k()},[e,k]);let J=_t(()=>{let s=[...d];if(e?.role!=="admin"&&e?.associatedTech?s=s.filter(i=>i.technician===e.associatedTech):E.searchTech&&(s=s.filter(i=>i.technician===E.searchTech)),E.viewAll||(s=s.filter(i=>{let f=(i.created_at||"").split("T")[0];return f>=E.dateFrom&&f<=E.dateTo})),E.searchTerm){let i=E.searchTerm.toLowerCase();s=s.filter(f=>(f.customerName||"").toLowerCase().includes(i)||(f.phone||"").includes(i)||(f.address||"").toLowerCase().includes(i))}return s.sort((i,f)=>new Date(f.created_at).getTime()-new Date(i.created_at).getTime())},[d,E,e]),S=Me((s=e)=>{Q(null),n({customerName:"",phone:"",address:"",status:te[0],technician:s?.associatedTech||"",content:"",workItems:[{desc:"",qty:1,price:"",total:0}],revenue:0,cost:0,debt:0})},[e]),re=async s=>{R(!0);try{let i=s==="update"?d.find(C=>C.id===F):null,f={id:s==="create"?Date.now().toString():F,created_at:s==="create"?new Date().toISOString():i?.created_at||new Date().toISOString(),customer_name:w.customerName,phone:w.phone,address:w.address,status:w.status,technician:w.technician,content:w.content,work_items:Array.isArray(w.workItems)?w.workItems:[],revenue:Number(w.revenue),cost:Number(w.cost),debt:Number(w.debt),search_key:`${w.customerName} ${w.phone} ${w.address}`.toLowerCase()},$=await Y(o.sheetUrl,s,f);$?.status==="success"||$?.status==="updated"?(await k(),S()):alert($?.error||"L\u1ED7i thao t\xE1c Server")}catch{alert("L\u1ED7i k\u1EBFt n\u1ED1i Server")}finally{R(!1)}};return e?ne("div",{className:"flex flex-col min-h-screen bg-slate-50 font-sans",children:[A("header",{className:"sticky top-0 z-40 bg-white border-b px-4 py-3 shadow-sm",children:ne("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[ne("div",{className:"flex items-center gap-3",children:[A(V,{size:32}),ne("div",{children:[A("h1",{className:"font-bold text-slate-800 text-[12px] uppercase",children:"DITICOMS SERVICE"}),A("span",{className:"text-slate-400 text-[10px] uppercase font-bold",children:e.name})]})]}),ne("div",{className:"flex gap-2",children:[A("button",{onClick:()=>U(!0),className:"p-2 text-slate-400 hover:text-blue-500",children:A(Et,{size:18})}),A("button",{onClick:()=>{confirm("\u0110\u0103ng xu\u1EA5t?")&&(r(null),localStorage.clear(),window.location.reload())},className:"p-2 text-red-400",children:A(Dt,{size:18})})]})]})}),A("main",{className:"flex-1 lg:h-[calc(100vh-64px)] overflow-y-auto lg:overflow-hidden",children:ne("div",{className:"max-w-7xl mx-auto p-4 lg:p-6 h-full grid grid-cols-1 lg:grid-cols-12 gap-6",children:[A("div",{className:"lg:col-span-5 h-full bg-white rounded-2xl shadow-sm border overflow-hidden flex flex-col",children:A("div",{className:"flex-1 overflow-y-auto p-5 custom-scrollbar",children:A(Oe,{formData:w,setFormData:n,technicians:h,priceList:v,selectedId:F,isSubmitting:_,currentUser:e,services:d,bankInfo:o.bankInfo,onClear:()=>S(),onSave:()=>re("create"),onUpdate:()=>re("update"),onDelete:async()=>{if(!(!F||!confirm("X\xF3a phi\u1EBFu n\xE0y?"))){R(!0);try{await Y(o.sheetUrl,"delete",{id:F,role:e?.role}),await k(),S()}catch{alert("L\u1ED7i x\xF3a")}finally{R(!1)}}}})})}),A("div",{className:"lg:col-span-7 h-full flex flex-col min-h-[500px]",children:A(Se,{data:J,loading:z,technicians:h,selectedId:F,onSelectRow:s=>{Q(s.id),n({customerName:s.customerName||"",phone:s.phone||"",address:s.address||"",status:s.status||te[0],technician:s.technician||"",content:s.content||"",workItems:Array.isArray(s.workItems)?[...s.workItems]:[],revenue:Number(s.revenue||0),cost:Number(s.cost||0),debt:Number(s.debt||0)}),window.innerWidth<1024&&window.scrollTo({top:0,behavior:"smooth"})},filters:E,setFilters:{setDateFrom:s=>B(i=>({...i,dateFrom:s,viewAll:!1})),setDateTo:s=>B(i=>({...i,dateTo:s,viewAll:!1})),setSearchTerm:s=>B(i=>({...i,searchTerm:s})),setSearchTech:s=>B(i=>({...i,searchTech:s})),setViewAll:s=>B(i=>({...i,viewAll:s}))},currentUser:e})})]})}),A(De,{services:d,onApplyFilter:s=>B(i=>({...i,...s}))}),P&&A(_e,{config:o,isAdmin:e.role==="admin",onClose:()=>U(!1),onSave:s=>{m(s),localStorage.setItem("diti_config",JSON.stringify(s)),U(!1)}})]}):A(Ne,{onLogin:async(s,i)=>{M(!0);try{let f=await Y(o.sheetUrl,"login",{username:s,password:i});f?.status==="success"&&f.user?(r(f.user),localStorage.setItem("diti_user",JSON.stringify(f.user)),S(f.user)):alert(f?.error||"Sai th\xF4ng tin")}catch{alert("L\u1ED7i k\u1EBFt n\u1ED1i")}finally{M(!1)}},isLoading:z})},Fe=Mt;import{jsx as je}from"react/jsx-runtime";var jt=()=>{typeof window.removeSplash=="function"&&window.removeSplash()},He=document.getElementById("root");He&&(jt(),Ht(He).render(je(Ft.StrictMode,{children:je(Fe,{})})));
